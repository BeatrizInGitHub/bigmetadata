{%- macro build_column(col, depth=0) %}

.. _{{ col.id }}:

{{ col.name }}
{%
  if depth == 0
%}---------------------------------------------------------------------------{%
  elif depth == 1
%}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^{%
  elif depth == 2
%}"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""{%
  endif
%}

{{ col.description }}

{% if col.extra.categories %}
  {% for catname, category in col.extra.categories.items() %}
  * **{{ catname }}**: {{ category.description }}
  {% endfor %}
{% endif %}
{#
Code example
#}

{% if col.type|lower == 'text' %}
Obtain category of "{{ col.name }}" at one point:
{% elif col.type|lower == 'numeric' %}
Measure "{{ col.name }}" {% if col.summable() %}density per sq. kilometer{% endif %}for one point:
{% elif col.type|lower == 'geometry' %}
Obtain "{{ col.name }}" geometry at one point:
{% endif %}

.. code:: postgresql

{% if col.type|lower == 'text' %}

  SELECT cdb_observatory.OBS_GetCategory(
    CDB_LatLng(40.7, -73.9),
    '{{ col.id }}'
  );

{% elif col.type|lower == 'numeric' %}

  SELECT cdb_observatory.OBS_GetMeasure(
    CDB_LatLng(40.7, -73.9),
    '{{ col.id }}'
  );

{% elif col.type|lower == 'geometry' %}

  SELECT cdb_observatory.OBS_GetBoundary(
    CDB_LatLng(40.7, -73.9),
    '{{ col.id }}'
  );

{% endif %}

{% if col.type|lower == 'text' %}
Obtain category of "{{ col.name }}" within an area:

.. code:: postgresql

  SELECT cdb_observatory.OBS_GetCategory(
    ST_Buffer(CDB_LatLng(40.7, -73.9), 0.01),
    '{{ col.id }}'
  );

{% elif col.type|lower == 'numeric' %}
{% if col.summable() %}
Measure "{{ col.name }}" within an area:

.. code:: postgresql

  SELECT cdb_observatory.OBS_GetMeasure(
    ST_Buffer(CDB_LatLng(40.7, -73.9), 0.01),
    '{{ col.id }}'
  );

{% else %}

{{ col.name }} is only available for point lookups.
{% endif %}
{% elif col.type|lower == 'geometry' %}

Obtain all "{{ col.name }}" geometries within an area:

.. code:: postgresql

  SELECT cdb_observatory.OBS_GetBoundariesByGeometry(
    ST_Buffer(CDB_LatLng(40.7, -73.9), 0.01),
    '{{ col.id }}'
  );

{% endif %}

{% if col.has_denominator() %}
Measure "{{ col.name }}" percent of "{{ col.denominator().name }}" at one point:

.. code:: postgresql

  SELECT cdb_observatory.OBS_GetMeasure(
    CDB_LatLng(40.7, -73.9),
    '{{ col.id }}', 'denominator'
  );

{% if col.summable() %}
Measure "{{ col.name }}" percent of "{{ col.denominator().name }}" within an area:

.. code:: postgresql

  SELECT cdb_observatory.OBS_GetMeasure(
    ST_Buffer(CDB_LatLng(40.7, -73.9), 0.01),
    '{{ col.id }}', 'denominator'
  );
{% endif %}

{% endif %}
{# preview map #}
{#
.. rst-class:: cartodb-static-map
   {{ table.tablename }}.{{ coltable.colname }}
   #}

{% if format == 'html' %}
{% for coltable in col.tables %}
    {% set table = coltable.table %}
    {#:{{ table.timespan }}:#}

    `On Carto <http://observatory.cartodb.com/tables/{{ table.tablename }}>`_
{% endfor %}
{% endif %}

{% for target, reltype in col.targets.iteritems() %}
:{{ reltype }}:

    :ref:`{{ target.id }}`
{% endfor %}

{% if col.has_children() %}
.. contents:: Subcolumns of {{ col.name }}
   :local:
   :depth: 1

  {% for denom in col.children() %}
  {{ build_column(denom, depth + 1) }}
  {% endfor %}
{% endif %}
{%- endmacro %}
