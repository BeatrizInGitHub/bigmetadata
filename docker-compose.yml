version: '3.1'
services:
  postgres:
    image: carto/bigmetadata_postgres
    volumes:
      - ${DO_LOCAL_POSTGRESQL_LIB_DIR:-./postgres/data}:/var/lib/postgresql
      - ./observatory-extension:/observatory-extension
      - ./dataservices-api:/dataservices-api
      - ./data-services:/data-services
      - ./cartodb-postgresql:/cartodb-postgresql
      - ${DO_LOCAL_POSTGRESQL_TMP_DIR:-./tmp}:/bigmetadata/tmp
    environment:
      PGUSER: docker
      PGPASSWORD: docker
      PGDATABASE: gis
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    privileged: true
    ports:
      - 5554:5432
    env_file: .env
    network_mode: bridge

  nginx:
    image: nginx:latest
    volumes:
      - ./conf/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./catalog/build/html:/usr/share/nginx/html/catalog/:ro
      - ./docs/build/html:/usr/share/nginx/html/docs/:ro
      - ./perftest:/usr/share/nginx/html/perftest/:ro
    ports:
      - 80
    network_mode: bridge

  bigmetadata_daemon:
    image: carto/bigmetadata
    links:
      - postgres
    volumes:
      - .:/bigmetadata
    ports:
      - 8082
    environment:
      PYTHONPATH: /bigmetadata
      PGHOST: postgres
      PGUSER: docker
      PGPASSWORD: docker
      PGDATABASE: gis
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      LUIGI_CONFIG_PATH: /bigmetadata/conf/luigi_daemon.cfg
    env_file: .env
    command: "/bin/bash -c 'while : ; do pg_isready -t 1 && break; done && luigid'"
    network_mode: bridge

  bigmetadata:
    image: carto/bigmetadata
    links:
      - postgres
      - bigmetadata_daemon
    volumes:
      - .:/bigmetadata
    environment:
      PYTHONPATH: /bigmetadata
      PGHOST: postgres
      PGUSER: docker
      PGPASSWORD: docker
      PGDATABASE: gis
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      LUIGI_CONFIG_PATH: /bigmetadata/conf/luigi_client.cfg
    env_file: .env
    stdin_open: true
    tty: true
    network_mode: bridge
